var ViewModel=function(){var a,b,c,d,e,f=this;f.allPlaces=ko.observableArray([]),this.initialize=function(){a=new google.maps.LatLng(41.896046,12.476709),b=new google.maps.Map(document.getElementById("map-canvas"),{center:a,zoom:15,disableDefaultUI:!0}),this.getAllPlaces()},this.getAllPlaces=function(){var d={location:a,radius:1e3,types:["museum"]};e=new google.maps.places.PlacesService(b),c=new google.maps.InfoWindow,e.nearbySearch(d,this.getAllPlacesCallback)},this.getAllPlacesCallback=function(a,c){c==google.maps.places.PlacesServiceStatus.OK&&(d=new google.maps.LatLngBounds,a.forEach(function(a){a.marker=f.createMarker(a),a.isInFilteredList=ko.observable(!0),f.allPlaces.push(a),d.extend(new google.maps.LatLng(a.geometry.location.lat(),a.geometry.location.lng()))}),b.fitBounds(d))},this.createMarker=function(a){var c=new google.maps.Marker({map:b,position:a.geometry.location});return google.maps.event.addListener(c,"click",function(){document.getElementById(a.id).scrollIntoView(),$("#"+a.id).trigger("click")}),c},this.getStreet=function(a){var b=a.indexOf(","),c=a.slice(0,b)+".";return c},this.getCityState=function(a){var b=a.indexOf(","),c=a.slice(b+1);return c=c.replace(", Italy","")},f.filteredPlaces=ko.computed(function(){return f.allPlaces().filter(function(a){return a.isInFilteredList()})}),f.chosenPlace=ko.observable(),f.query=ko.observable(""),f.searchTerms=ko.computed(function(){return f.query().toLowerCase().split(" ")}),f.search=function(){f.chosenPlace(null),c.setMap(null),f.allPlaces().forEach(function(a){a.isInFilteredList(!1),a.marker.setMap(null)}),f.searchTerms().forEach(function(a){f.allPlaces().forEach(function(c){(-1!==c.name.toLowerCase().indexOf(a)||-1!==c.types.indexOf(a))&&(c.isInFilteredList(!0),c.marker.setMap(b))})})},f.selectPlace=function(a){a===f.chosenPlace()?f.getWiki(a):(f.filteredPlaces().forEach(function(a){a.marker.setAnimation(null)}),f.chosenPlace(a),a.marker.setAnimation(google.maps.Animation.BOUNCE),f.getWiki(a))},f.displayingList=ko.observable(!0),f.listToggleIcon=ko.computed(function(){return f.displayingList()?"fa fa-minus-square fa-2x fa-inverse":"fa fa-plus-square fa-2x fa-inverse"}),f.toggleListDisplay=function(){f.displayingList(f.displayingList()?!1:!0)},f.displayInfo=function(a,d){var g="",h={placeId:a.place_id};e.getDetails(h,function(e,h){var i="<h4>"+a.name+"</h4>",j="",k="",l="";h==google.maps.places.PlacesServiceStatus.OK&&(e.website&&(i='<h4><a target="_blank" href='+e.website+">"+a.name+"</a></h4>"),e.formatted_phone_number&&(l="<p>"+e.formatted_phone_number+"</p>"),e.formatted_address&&(j="<p>"+f.getStreet(e.formatted_address)+"</p>",k="<p>"+f.getCityState(e.formatted_address)+"<p>")),g='<div class="streetview" id="street-view"></div>',g=g+"<div>"+i+j+k+l+"</div>",g=g+"<div>"+d+"</div>",c.setContent(g),c.open(b,a.marker);new google.maps.StreetViewPanorama(document.getElementById("street-view"),{position:{lat:a.geometry.location.lat(),lng:a.geometry.location.lng()},pov:{heading:165,pitch:0},zoom:1});b.panTo(a.marker.position)})},f.getWiki=function(a){var b="",c="",d="https://en.wikipedia.org//w/api.php?action=opensearch&search="+a.name+"&format=json&redirect=return&callback=wikiCallback",e=setTimeout(function(){c='<i class="fa fa-wikipedia-w fa-2x"></i> - Failed request to Wikipedia',f.displayInfo(a,c)},3e3);$.ajax({url:d,dataType:"jsonp"}).success(function(g){1===g[1].length?(b=g[1],d=g[3],c='<i class="fa fa-wikipedia-w fa-2x"></i> - <a href="'+d+'" target="_blank">'+b+"</a>"):c='<i class="fa fa-wikipedia-w fa-2x"></i> - Wikipedia links not founded',clearTimeout(e),f.displayInfo(a,c)})},this.initialize(),window.addEventListener("resize",function(){b.fitBounds(d)}),google.maps.event.addListener(c,"closeclick",function(){f.chosenPlace().marker.setAnimation(null),f.chosenPlace(null)}),$(function(){$(window).width()<650&&f.displayingList()&&f.displayingList(!1)}())};ko.applyBindings(new ViewModel);